name: Build and Release Firmware

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Determine release type
        id: release_type
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"
          if [[ "$TAG_NAME" == *-precert ]]; then
            echo "type=precert" >> $GITHUB_OUTPUT
            echo "Building precertificate firmware for tag: $TAG_NAME"
          elif [[ "$TAG_NAME" == *-self-signed ]]; then
            echo "type=self-signed" >> $GITHUB_OUTPUT
            echo "Building self-signed firmware for tag: $TAG_NAME"
          else
            echo "type=unknown" >> $GITHUB_OUTPUT
            echo "Unknown release type for tag: $TAG_NAME"
            exit 1
          fi

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt install -y make curl tar gawk grep coreutils openssl

      - name: Build precertificate firmware
        if: steps.release_type.outputs.type == 'precert'
        run: |
          cd precertificate-firmware
          make

      - name: Build self-signed firmware
        if: steps.release_type.outputs.type == 'self-signed'
        run: |
          cd self-signed-firmware/automated
          make

      - name: Upload precertificate firmware to release
        if: steps.release_type.outputs.type == 'precert'
        uses: softprops/action-gh-release@v1
        with:
          files: precertificate-firmware/firmware/*.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload self-signed firmware to release
        if: steps.release_type.outputs.type == 'self-signed'
        uses: softprops/action-gh-release@v1
        with:
          files: self-signed-firmware/automated/*.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
